<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.inven.mapper.RequestMapper">

	<sql id="titleColumn">
      request_code, product_code, request_status, unit_price, factory_name, etc, file_name, total_order_quantity,
      date(request_date) as request_date, date(get_Date) as get_date, date(manufacturing_date) as manufacturing_date
   </sql>

	<sql id="commonQuery">
      select *
      from request_title rt
      join request_detail rd
      on rt.request_code = rd.request_code
   </sql>

	<!-- 디테일 테이블만 조회 -->
	<select id="searchDetail" parameterType="hashMap" resultType="hashmap">
      select *
      from request_detail
   </select>

	<!-- 조회 전체 카운트 -->
	<select id="searchCount" parameterType="hashMap" resultType="int">
		select count(*)
		from request_title
		<choose>
			<when test="confirm.equals('request_code') and !value.equals('')">
				where request_code = #{value}
			</when>
			<when test="confirm.equals('product_code') and !value.equals('')">
				where product_code = #{value}
			</when>
			<when test="confirm.equals('request_date') and !start_date.equals('') and !end_date.equals('')">
				where Date(request_date) between #{start_date} and #{end_date}
			</when>
			<when test="confirm.equals('request_status') and !value.equals('')">
				where request_status = #{value}
			</when>
		</choose>
	</select>

	<!-- 검색 및 페이징 -->
	<select id="searchWhere" parameterType="hashMap" resultType="hashmap">
		select <include refid="titleColumn"/>
		from request_title
		<choose>
			<when test="confirm.equals('request_code') and !value.equals('')">
				where request_code = #{value}
			</when>
			<when test="confirm.equals('product_code') and !value.equals('')">
				where product_code = #{value}
			</when>
			<when test="confirm.equals('request_date') and !start_date.equals('') and !end_date.equals('')">
				where Date(request_date) between #{start_date} and #{end_date}
			</when>
			<when test="confirm.equals('request_status') and !value.equals('')">
				where request_status = #{value}
			</when>
		</choose>
		LIMIT #{start_idx}, #{end_idx}
	</select>

	<update id="upStatus" parameterType="hashMap">
      UPDATE request_title
      SET request_status = #{request_status}
      WHERE request_code = #{request_code}
   </update>

	<insert id="addTitle" parameterType="hashMap" >
      insert into request_title(
      request_code, product_code,
      request_status,
      unit_price, factory_name, manufacturing_date,etc
      )
      values(
      #{request_code},
      #{product_code}, #{request_status.val()},
      ${unit_price}, #{factory_name}, #{manufacturing_date},#{etc}
      )
   </insert>

	<insert id="addDetail" parameterType="hashMap">
      insert into request_detail(
      request_code,product_code,gender,color_name,s,m,l,xl,free,total
      )
      values(
      #{request_code},#{product_code},#{gender},#{color_name},#{s},#{m},#{l},#{xl},#{free},#{total}
      )
   </insert>
	<select id="makeReqCode" resultType="String">
      SELECT FN_MAKE_REQ_CODE()
   </select>

	<select id="selectProductCode" resultType="String">
      SELECT product_code from product_title
   </select>

</mapper>